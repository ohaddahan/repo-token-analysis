name: Tag

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Get version from package.json
        id: version
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          MAJOR=${PKG_VERSION%%.*}
          echo "version=${PKG_VERSION}" >> "$GITHUB_OUTPUT"
          echo "major=${MAJOR}" >> "$GITHUB_OUTPUT"
      - name: Validate versions match
        env:
          PKG_VERSION: ${{ steps.version.outputs.version }}
        run: |
          ACTION_VERSION=$(grep -oP '(?<=:v)\S+' action.yml | tr -d "'\"")
          if [[ "$ACTION_VERSION" != "$PKG_VERSION" ]]; then
            echo "::error::Version mismatch: action.yml has v${ACTION_VERSION}, package.json has ${PKG_VERSION}"
            echo "Run ./scripts/bump.sh to sync versions"
            exit 1
          fi
      - name: Push version tag
        run: |
          git tag "v${{ steps.version.outputs.version }}"
          git push origin "v${{ steps.version.outputs.version }}"
      - name: Force-update floating major tag
        run: |
          git tag -f "v${{ steps.version.outputs.major }}" "v${{ steps.version.outputs.version }}"
          git push -f origin "v${{ steps.version.outputs.major }}"